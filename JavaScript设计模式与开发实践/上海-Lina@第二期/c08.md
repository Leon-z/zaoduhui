### 第八章  发布-订阅模式 ###

> 发布-订阅模式又叫观察者模式，它定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖它的对象都将得到通知。在javaScript中，我们一般用时间模型来替代传统的发布=订阅模式。

####1、简单的观察者模式
观察者模式在开发中也是比较常见的，比如`JS`中的事件监控等等。
书本中，使用了一个售楼案例来说明观察者模式。

案例背景：小明最近想买房子，去售楼处看楼盘，但是看中的楼盘还未推出，但是楼盘推出的时间也没有确定。  

案例问题：小明如何获得楼盘推出的时间  

解决方法1：小明索要售楼处小姐电话号码，每天打电话咨询  

解决方法2：售楼处索要小明电话号码，等售楼处得知楼盘推出的时间后，通知小明。  


但是我们还要知道的一个信息是，小明不是[一个人]而是[许多人]  

很容易看出来解决方法2要远远优于解决方法1：
1. 小明不用每天给售楼小姐打电话
2. 售楼处的人员电话号码等的变更也不会影响到小明获取消息。
  
  
使用解决方法2，我们可以让两个对象松耦合的联系在一起。  

基于解决方法2，我们可以用代码对其进行实现。  

[售楼处消息通知案例](http://runjs.cn/code/miavkaeq)  

这里只做了简单的通知，需要选择性的对订阅者进行的发布消息传递，可在发布消息中做进一步的处理。

####2、发布-订阅模式的通用实现
在简单的观察者模式中，我们的小明（订阅者）是可以随时增加的，但是只有一个售楼处，如果小明到售楼处2，那么在售楼处2也要实现这一套一模一样的 【订阅-发布】 机制。

我们可以将售楼处的【订阅-发布】逻辑提取出来，实现对象的“一建获取”【订阅-发布】功能。

<pre>
var event = {
    //缓存列表，存放订阅者的回调函数
	clientList : [];
	//增加订阅者
	listen : function(fn){
		this.clientList.push(fn);
	}
	//发布消息
	trigger : function(){
	for(var i = 0,fn; fn = this.clientList[i++];){
			fn.apply(this,arguments);
		}
	}
}
</pre>

再定义一个函数，可以给对象动态“一键获取”【订阅-发布】功能
<pre>
var getEvent = function(obj){
	for(var i in obj){
    	obj[i] = event[i];
    }
}
</pre>

####3、全局的发布-订阅对象
从【2、发布-订阅模式的通用实现】中，我们依然可以发现存在的问题。  

1. 需要给每个发布者都添加【发布】功能
2. 发布和订阅者之间还存在一定的耦合。订阅者（小明）需要知道发布者（售楼处）的名字才可以订阅。

这个问题现实中已经给出了答案：中介

我们一般是从中介公司上浏览所有的售楼处的信息。对于售楼处和小明来说，他们只需知道一个中介的信息即可。  

[全局订阅-发布功能案例代码](http://runjs.cn/code/vhbxvx6t)  

这里依然是简单的通知代码。


####4、小结

1. 优点：时间上解耦；对象之间解耦
2. 缺点：创建订阅者需要消耗内存；对象之间太解耦不利于程序的跟踪和维护

小问题：以上所介绍的都是 先订阅-后发布，然而 先发布-后订阅 的需求也是存在的。

